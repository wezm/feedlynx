env:
  PATH: "$HOME/.cargo/bin:$PATH"
  RUST_VERSION: '1.72.1' # Needs to be <= FreeBSD quarterly version
  #AWS_ACCESS_KEY_ID: ENCRYPTED[44da4d040f7e219d5394590e9d8e3d684605a50603bfbf50c27a7f1fc1eba7448f09294b75945db653debbbe22f26d26]
  #AWS_SECRET_ACCESS_KEY: ENCRYPTED[216986009641f20db5d35fa6df20de4f4f9bdba934494b6ebe6d50661a559930624a4d79d2a871aa49b6420336eb4cd1]

task:
  name: Build (Debian Linux arm64)
  arm_container:
    image: debian:12-slim
    cpu: 4
  cargo_cache:
    folder: $HOME/.cargo/registry
    fingerprint_script: cat Cargo.lock
  install_script:
    - apt-get update && apt-get install -y --no-install-recommends git ca-certificates curl gcc libc6-dev musl-tools
    - curl https://sh.rustup.rs -sSf | sh -s -- -y --profile minimal --default-toolchain ${RUST_VERSION}
    - rustup target add aarch64-unknown-linux-musl
    - mkdir ~/bin
    #- curl -L https://releases.wezm.net/upload-to-s3/0.2.0/upload-to-s3-0.2.0-aarch64-unknown-linux-musl.tar.gz | tar xzf - -C ~/bin
  test_script:
    - cargo test
  publish_script: |
    tag=$(git describe --exact-match HEAD 2>/dev/null || true)
    if [ -n "$tag" ]; then
      cargo build --release --locked --target aarch64-unknown-linux-musl
      tarball="feedlynx-${tag}-aarch64-unknown-linux-musl.tar.gz"
      strip target/aarch64-unknown-linux-musl/release/feedlynx
      tar zcf "$tarball" -C target/aarch64-unknown-linux-musl/release feedlynx
      #~/bin/upload-to-s3 -b releases.wezm.net "$tarball" "feedlynx/$tag/$tarball"
    fi
